{% load static %}
<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>کافه دنج | منوی دیجیتال</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  </head>
  <body class="dark-theme">

    <div class="cafe-navbar-dark sticky-top">
      <div class="container text-center py-3">
        <h1 class="cafe-title-dark h4 mb-3">☕ کافه دنج</h1>
        <div class="d-flex gap-2 overflow-auto no-scrollbar pb-2 justify-content-center">
          {% for category in categories %}
          <a href="#cat-{{ category.id }}" class="badge category-link-dark text-decoration-none px-3 py-2">
            {{ category.name }}
          </a>
          {% endfor %}
        </div>
      </div>
    </div>

    <form method="POST" action="{% url 'submit_order' %}" class="container mt-4 mb-5 pb-5">
      {% csrf_token %} 
      
      {% for category in categories %}
      <div id="cat-{{ category.id }}" class="mb-5">
        <h2 class="category-header-dark h5">{{ category.name }}</h2>

        <div class="row g-3">
          {% for item in category.items.all %}
          <div class="col-12">
            <div class="menu-card-dark" id="card-{{ item.id }}">
              <img src="{% if item.image %}{{ item.image.url }}{% else %}https://via.placeholder.com/150{% endif %}" class="item-image-dark" alt="{{ item.name }}" />
              
              <div class="item-details-dark">
                <div class="item-name-dark">{{ item.name }}</div>
                {% if item.subtitle %}
                <div class="item-description-dark opacity-75 mt-1">{{ item.subtitle }}</div>
                {% endif %}
                <div class="item-price-dark mt-2">{{ item.price }} تومان</div>
              </div>

              <div class="quantity-control-dark">
                  <button type="button" class="qty-btn-dark" onclick="changeQty('{{ item.id }}', 1)">+</button>
                  <span id="qty-text-{{ item.id }}" class="qty-display-dark">0</span>
                  <button type="button" class="qty-btn-dark" onclick="changeQty('{{ item.id }}', -1)">-</button>
              </div>

              <input type="number" id="qty-{{ item.id }}" name="quantity_{{ item.id }}" value="0" class="qty-input" />
              <input type="checkbox" name="items" value="{{ item.id }}" id="check-{{ item.id }}" class="item-checkbox" />
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endfor %}

      <div class="fixed-bottom p-3 order-bar-dark">
        <div class="container">
          <button type="button" class="btn w-100 order-btn-dark" data-bs-toggle="modal" data-bs-target="#orderModal">
            مشاهده سبد خرید و ثبت سفارش
          </button>
        </div>
      </div>

      <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content modal-content-dark">
            <div class="modal-header border-0">
                <h5 class="modal-title-dark">تایید نهایی سفارش</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-4">
              <h6 class="mb-4">لطفا شماره میز خود را وارد کنید:</h6>
              <input type="number" name="table_number" class="form-control form-control-lg text-center mx-auto mb-4 table-input-dark" required />
              <button type="submit" class="btn w-100 submit-btn-dark">ثبت نهایی سفارش</button>
            </div>
          </div>
        </div>
      </div>
    </form>

    <script>
      function changeQty(itemId, delta) {
        const input = document.getElementById("qty-" + itemId);
        const textDisplay = document.getElementById("qty-text-" + itemId);
        const checkbox = document.getElementById("check-" + itemId);
        
        let val = parseInt(input.value) + delta;
        if (val < 0) val = 0;
        
        input.value = val;
        textDisplay.innerText = val;
        checkbox.checked = val > 0;
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>